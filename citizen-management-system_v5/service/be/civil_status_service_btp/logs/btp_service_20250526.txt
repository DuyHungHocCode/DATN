2025-05-26 15:08:45,536 - app.main - INFO - BTP Civil Status Service starting, logs will be saved to: logs/btp_service_20250526.txt
2025-05-26 15:08:45,539 - app.main - INFO - Civil Status Service starting up...
2025-05-26 15:08:45,539 - app.services.outbox_processor - INFO - Outbox processor started
2025-05-26 15:08:45,539 - app.services.event_retry_worker - INFO - Event retry worker started
2025-05-26 15:08:45,539 - app.services.reconciliation - INFO - Reconciliation service started
2025-05-26 15:08:45,655 - app.services.reconciliation - INFO - Starting marriage records consistency check
2025-05-26 15:08:45,658 - app.services.reconciliation - INFO - No marriage inconsistencies found
2025-05-26 15:08:45,659 - app.services.reconciliation - INFO - Starting death records consistency check
2025-05-26 15:13:45,633 - kafka.conn - INFO - <BrokerConnection client_id=kafka-python-producer-1, node_id=1 host=localhost:29092 <connecting> [IPv4 ('127.0.0.1', 29092)]>: connecting to localhost:29092 [('127.0.0.1', 29092) IPv4]
2025-05-26 15:13:45,634 - kafka.conn - INFO - <BrokerConnection client_id=kafka-python-producer-1, node_id=1 host=localhost:29092 <connected> [IPv4 ('127.0.0.1', 29092)]>: Connection complete.
2025-05-26 15:13:45,635 - kafka.conn - INFO - <BrokerConnection client_id=kafka-python-producer-1, node_id=bootstrap-0 host=localhost:29092 <connected> [IPv4 ('127.0.0.1', 29092)]>: Closing connection. 
2025-05-26 15:30:16,089 - app.api.router - INFO - Received request to register death certificate for citizen: 001198752461
2025-05-26 15:30:16,408 - httpx - INFO - HTTP Request: GET http://localhost:8000/api/v1/citizens/001198752461/validation "HTTP/1.1 200 OK"
2025-05-26 15:30:16,409 - app.api.router - INFO - Citizen 001198752461 validation successful (status: None). Proceeding with registration.
2025-05-26 15:30:16,420 - app.api.router - INFO - Successfully created death certificate record with ID: 3
2025-05-26 15:30:16,420 - app.api.router - INFO - Added Kafka event sending task to background for certificate ID: 3
2025-05-26 15:30:16,421 - app.services.kafka_producer - INFO - Sending event to Kafka topic: btp_events
2025-05-26 15:30:16,457 - app.services.kafka_producer - INFO - Event sent successfully to topic: btp_events, partition: 0, offset: 36
2025-05-26 15:59:43,859 - app.api.router - INFO - Request to get death certificate with ID: 3
2025-05-26 15:59:43,863 - app.api.router - INFO - Raw death certificate data: {'death_certificate_id': 3, 'citizen_id': '001198752461', 'death_certificate_no': 'GCT-2025-00001', 'book_id': 'CT-2025-X', 'page_no': '01', 'date_of_death': datetime.date(2025, 5, 25), 'time_of_death': datetime.time(10, 30), 'place_of_death_detail': 'Tại nhà riêng, Số 105, Ngách 12, Ngõ 4, Thổ Quan', 'place_of_death_ward_id': 107, 'place_of_death_district_id': None, 'place_of_death_province_id': None, 'cause_of_death': 'Đột quỵ', 'declarant_name': 'Vũ Thị Thủy', 'declarant_citizen_id': '001196325874', 'declarant_relationship': 'Em gái', 'registration_date': datetime.date(2025, 5, 26), 'issuing_authority_id': 201, 'death_notification_no': 'TTBN-2025-0001', 'witness1_name': 'Nguyễn Văn An', 'witness2_name': 'Lê Thị Bình', 'status': True, 'notes': 'Công dân qua đời tại nhà riêng sau thời gian bệnh nặng.', 'created_at': datetime.datetime(2025, 5, 26, 8, 30, 16, 415136), 'updated_at': datetime.datetime(2025, 5, 26, 8, 30, 16, 415136)}
2025-05-26 15:59:43,863 - app.api.router - INFO - IDs to resolve: {'ward_id': 107, 'district_id': None, 'province_id': None, 'authority_id': 201}
2025-05-26 15:59:43,863 - app.api.router - INFO - Fetching Wards data from BCA
2025-05-26 15:59:53,892 - app.api.router - ERROR - Error fetching reference data from BCA: 504: Gọi dịch vụ BCA (get_reference_data) cho bảng 'Wards' bị timeout.
Traceback (most recent call last):
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_transports/default.py", line 101, in map_httpcore_exceptions
    yield
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_transports/default.py", line 394, in handle_async_request
    resp = await self._pool.handle_async_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpcore/_async/connection_pool.py", line 256, in handle_async_request
    raise exc from None
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpcore/_async/connection_pool.py", line 236, in handle_async_request
    response = await connection.handle_async_request(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpcore/_async/connection.py", line 103, in handle_async_request
    return await self._connection.handle_async_request(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpcore/_async/http11.py", line 136, in handle_async_request
    raise exc
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpcore/_async/http11.py", line 106, in handle_async_request
    ) = await self._receive_response_headers(**kwargs)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpcore/_async/http11.py", line 177, in _receive_response_headers
    event = await self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpcore/_async/http11.py", line 217, in _receive_event
    data = await self._network_stream.read(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpcore/_backends/anyio.py", line 32, in read
    with map_exceptions(exc_map):
  File "/usr/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpcore/_exceptions.py", line 14, in map_exceptions
    raise to_exc(exc) from exc
httpcore.ReadTimeout

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/duyhung/Desktop/DATN/citizen-management-system_v5/service/be/civil_status_service_btp/app/services/bca_client.py", line 129, in get_reference_data
    response = await client.get(f"{settings.API_V1_STR}/references/", params={"tables": tables_query_param})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_client.py", line 1768, in get
    return await self.request(
           ^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_client.py", line 1540, in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_client.py", line 1629, in send
    response = await self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_client.py", line 1657, in _send_handling_auth
    response = await self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_client.py", line 1694, in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_client.py", line 1730, in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_transports/default.py", line 393, in handle_async_request
    with map_httpcore_exceptions():
  File "/usr/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/home/duyhung/Desktop/DATN/myenv/lib/python3.12/site-packages/httpx/_transports/default.py", line 118, in map_httpcore_exceptions
    raise mapped_exc(message) from exc
httpx.ReadTimeout

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/duyhung/Desktop/DATN/citizen-management-system_v5/service/be/civil_status_service_btp/app/api/router.py", line 168, in get_death_certificate
    wards_data = await bca_client.get_reference_data(["Wards"])
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/duyhung/Desktop/DATN/citizen-management-system_v5/service/be/civil_status_service_btp/app/services/bca_client.py", line 145, in get_reference_data
    raise HTTPException(
fastapi.exceptions.HTTPException: 504: Gọi dịch vụ BCA (get_reference_data) cho bảng 'Wards' bị timeout.
2025-05-26 15:59:53,903 - app.api.router - INFO - Final response data with names: {'death_certificate_id': 3, 'citizen_id': '001198752461', 'death_certificate_no': 'GCT-2025-00001', 'book_id': 'CT-2025-X', 'page_no': '01', 'date_of_death': datetime.date(2025, 5, 25), 'time_of_death': datetime.time(10, 30), 'place_of_death_detail': 'Tại nhà riêng, Số 105, Ngách 12, Ngõ 4, Thổ Quan', 'place_of_death_ward_id': 107, 'place_of_death_district_id': None, 'place_of_death_province_id': None, 'cause_of_death': 'Đột quỵ', 'declarant_name': 'Vũ Thị Thủy', 'declarant_citizen_id': '001196325874', 'declarant_relationship': 'Em gái', 'registration_date': datetime.date(2025, 5, 26), 'issuing_authority_id': 201, 'death_notification_no': 'TTBN-2025-0001', 'witness1_name': 'Nguyễn Văn An', 'witness2_name': 'Lê Thị Bình', 'status': True, 'notes': 'Công dân qua đời tại nhà riêng sau thời gian bệnh nặng.', 'created_at': datetime.datetime(2025, 5, 26, 8, 30, 16, 415136), 'updated_at': datetime.datetime(2025, 5, 26, 8, 30, 16, 415136), 'place_of_death_province_name': 'Không xác định', 'place_of_death_district_name': 'Không xác định', 'place_of_death_ward_name': 'Không xác định', 'issuing_authority_name': 'Không xác định'}
